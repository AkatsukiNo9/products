# 小さな勇者 ゲーム仕様書

## 1. 概要

*   **ゲームタイトル:** 小さな勇者 (A Little Hero)
*   **ジャンル:** 2Dトップダウンアクションアドベンチャーゲーム
*   **ゲームの目的:**
    プレイヤーキャラクターを操作し、複数の部屋で構成されたマップを探索します。各部屋には敵キャラクターや宝箱、NPCが配置されています。クエストをこなしながらキャラクターを強化し、最終目標であるダンジョンの最深部のボスキャラクターを倒し、「勝利のアイテム」を手に入れることを目指します。
*   **ターゲットプラットフォーム:** ウェブブラウザ (PWA対応)

## 2. ゲームプレイ

### 2.1. プレイヤー (player.ts)

*   **操作方法 (input.ts):**
    *   移動:
        *   上: `W` キー または `↑` (上矢印キー)
        *   下: `S` キー または `↓` (下矢印キー)
        *   左: `A` キー または `←` (左矢印キー)
        *   右: `D` キー または `→` (右矢印キー)
    *   攻撃: `Enter` キー または `Space` キー
    *   **インタラクション (会話など):** `E` キー
*   **基本ステータス (game-config.json, index.tsx):**
    *   最大HP: `PLAYER_MAX_HP` (初期値: 3)。クエスト報酬で増加可能。
    *   現在HP: 初期状態では最大HPと同じ。ダメージを受けると減少。
    *   移動速度: `PLAYER_SPEED` (例: 5.0 ピクセル/更新)
    *   サイズ (幅・高さ): `PLAYER_SIZE` (例: `TILE_SIZE` * 0.8)
    *   色: `PLAYER_COLOR` (例: "#ADD8E6")
    *   向いている方向: `up`, `down`, `left`, `right` (最後に押された移動キーに依存)
*   **アクション:**
    *   **移動:**
        *   8方向移動が可能。斜め移動時は速度が正規化される。
        *   壁 (`TileType.WALL`, `TileType.DUNGEON_WALL`) やマップ境界とは衝突し、それ以上進めない。
    *   **攻撃 (剣):**
        *   プレイヤーが向いている方向に剣を振る。
        *   敵キャラクター、ボス、未開封の宝箱にヒットする。
        *   攻撃範囲 (リーチ): `SWORD_SLASH_REACH`
        *   攻撃持続時間: `PLAYER_ATTACK_DURATION` (例: 200ms)
        *   攻撃クールダウン: `PLAYER_ATTACK_COOLDOWN` (例: 400ms)。クールダウン中は再攻撃不可。
    *   **ダメージを受ける:**
        *   敵やボス、およびその弾丸と接触すると1ダメージを受ける。
        *   ダメージ後、一定時間無敵状態になる (`PLAYER_INVULNERABILITY_DURATION`, 例: 1500ms)。
        *   無敵時間中はプレイヤーが点滅表示される。
    *   **HP回復:**
        *   「ハートドロップ」アイテムを取得するとHPが1回復する。
        *   「ヒーリングゾーン」に入るとHPが全回復する。
    *   **ゲームオーバーとリスポーン:**
        *   プレイヤーのHPが0になるとゲームオーバー。
        *   初期部屋 (`INITIAL_ROOM_ID`) の指定された開始位置 (`playerStart`) に、HPが全回復した状態でリスポーンする。
        *   リスポーン後、短時間の無敵状態が付与される。
*   **部屋移動:**
    *   部屋の端（上下左右）に到達し、その方向に出口 (`RoomData.exits`) が設定されていれば隣の部屋へ移動する。
    *   ボス戦中は部屋の出口が封鎖され、移動できない。
    *   部屋移動時、敵やアイテムは再配置されるが、宝箱の開封状態、ボスの撃破状態、クエストの進行状況は維持される。

### 2.2. NPCとクエストシステム (npc.ts, quest.ts)

*   **NPC (ノンプレイヤーキャラクター):**
    *   村などに配置されている友好的なキャラクター。
    *   プレイヤーは `E` キーでNPCに話しかけ、会話することができる。
    *   会話中はゲームの時間が停止し、画面下部にダイアログボックスが表示される。
    *   NPCはクエストの依頼者となったり、ゲームのヒントを与えたりする。
*   **クエストシステム:**
    *   **受注:** NPCとの会話を通じてクエストを受ける。
    *   **進行:** クエストには状態（未受注、進行中、完了、報酬受取済）があり、プレイヤーの行動によって変化する。
    *   **目的:** 「特定の敵を倒す」「アイテムを見つける」など、クエストごとに目的が設定される。
    *   **報酬:** クエストを完了し、依頼者のNPCに報告すると報酬がもらえる（例: 最大HPの増加）。
    *   **セーブ:** クエストの進行状況は自動的にセーブされる。
*   **最初のクエスト: 「厄介な魔物退治」**
    *   **依頼者:** 村の賢者サボ
    *   **目的:** `room2` に出現する遠距離攻撃型の敵を倒す。
    *   **報酬:** プレイヤーの最大HPが1増加する。

### 2.3. 敵キャラクター (enemy.ts)

#### 2.3.1. 共通仕様

*   プレイヤーが一定範囲内に入ると認識し、追跡を開始する。
*   プレイヤーの剣による攻撃でダメージを受けると、ノックバック（後方に押し出される）が発生する。
*   HPが0になると消滅し、一定確率で「ハートドロップ」をドロップする。

#### 2.3.2. 近接攻撃型 (Melee Enemy)

*   プレイヤーに接近し、接触することでダメージを与える。

#### 2.3.3. 遠距離攻撃型 (Ranged Enemy)

*   プレイヤーと一定の距離を保ちながら、弾を発射して攻撃する。
*   弾は壁に当たると消滅する。

### 2.4. ボスキャラクター (boss.ts)

ダンジョンの最深部 (`dungeon_treasure_room`) には強力なボス「ダンジョンガーディアン」が待ち受けている。

*   HPが非常に高く、多彩な攻撃パターンを持つ。
*   **フェーズ1 (HP > 50%):** プレイヤーに向かって複数の弾を扇状に発射する。
*   **フェーズ2 (HP <= 50%):** 色が変化し、攻撃が激化。弾幕攻撃に加えて、高速で突進するダッシュ攻撃を行う。
*   撃破すると「勝利のアイテム」が出現し、部屋の封鎖が解かれる。ボスの撃破状態はセーブされる。

### 2.5. アイテムとマップオブジェクト (items.ts)

*   **ハートドロップ (HeartDrop):** 取得するとHPが1回復する。
*   **宝箱 (TreasureChest):** 剣で攻撃すると開き、中からアイテム（ハートドロップなど）が出現する。開封状態はセーブされる。
*   **ヒーリングゾーン (HealingZone):** `village_area` などに設置されている。ゾーン内に入るとプレイヤーのHPが全回復する。
*   **勝利のアイテム (VictoryItem):** ボスを倒すと出現。取得するとゲームクリアとなる。

### 2.6. マップと部屋 (map.ts)

*   ゲームは複数の部屋 (`RoomData`) によって構成される。
*   各部屋はタイルベースのマップ、敵、宝箱、NPC、出口情報などを持つ。

## 3. UI (ユーザーインターフェース - ui.ts, game.ts)

*   **プレイヤーHP表示:** 画面左上にハートで表示。
*   **ボスHP表示:** ボス戦中、画面下部に体力バーで表示。
*   **ダイアログボックス:** NPCとの会話中、画面下部に表示。
*   **各種画面:**
    *   **タイトル画面:** 「新しい冒険」と「冒険の続き」（セーブデータがある場合）を選択できる。
    *   **ゲームオーバー画面:** プレイヤーのHPが0になると表示される。
    *   **ゲームクリア画面:** 「勝利のアイテム」を取得すると表示される。

## 4. 技術仕様 (抜粋)

*   **設定ファイル:** `game-config.json` にゲームの主要なパラメータを定義。
*   **主要モジュール:** `index.tsx`, `game.ts`, `player.ts`, `enemy.ts`, `boss.ts`, `items.ts`, `map.ts`, `input.ts`, `ui.ts`, `npc.ts`, `quest.ts`。
*   **ゲームループ:** `requestAnimationFrame` を使用。
*   **セーブ/ロード (`game.ts`):**
    *   `localStorage` を使用。
    *   部屋移動時、ボス撃破時、勝利アイテム取得時に自動セーブ。
    *   保存されるデータ: プレイヤー情報（HP、最大HP、位置）、現在の部屋ID、開封済みの宝箱リスト、撃破済みのボスリスト、出現中の勝利アイテム情報、**クエストの進行状況**。

## 5. PWA (Progressive Web App) 機能

*   **マニフェスト (`manifest.json`):** アプリのインストール情報を提供。
*   **Service Worker (`sw.js`):** オフラインで動作するためのリソースをキャッシュする。